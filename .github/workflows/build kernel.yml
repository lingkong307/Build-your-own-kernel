name: Aå†…æ ¸ç¼–è¯‘

permissions:
  contents: read

concurrency:
  group: kernel-build-${{ github.ref }}-${{ github.event.inputs.kernel_to_build }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      kernel_to_build:
        description: "é€‰æ‹©å†…æ ¸ç‰ˆæœ¬"
        required: true
        type: choice
        options:
          - "android12_5.10_168_2023-04_r9"
          - "android12_5.10_198_2024-01_r17"
          - "android12_5.10_205_2024-03_r9"
          - "android12_5.10_209_2024-05_r13"
          - "android12_5.10_218_2024-08_r14"
          - "android12_5.10_226_2024-11_r8"
          - "android12_5.10_233_2025-02_r1"
          - "android12_5.10_X_lts_r1"
          - "android13_5.10_198_2024-01_"
          - "android13_5.10_205_2024-03_"
          - "android13_5.10_209_2024-05_"
          - "android13_5.10_214_2024-07_"
          - "android13_5.10_218_2024-08_"
          - "android13_5.10_223_2024-11_"
          - "android13_5.10_228_2025-01_"
          - "android13_5.10_X_lts_"
          - "android13_5.15_123_2023-11_"
          - "android13_5.15_137_2024-01_"
          - "android13_5.15_144_2024-03_"
          - "android13_5.15_148_2024-05_"
          - "android13_5.15_151_2024-08_"
          - "android13_5.15_167_2024-11_"
          - "android13_5.15_170_2025-01_"
          - "android13_5.15_X_lts_"
          - "android14_5.15_131_2023-11_"
          - "android14_5.15_137_2024-01_"
          - "android14_5.15_144_2024-03_"
          - "android14_5.15_148_2024-05_"
          - "android14_5.15_149_2024-06_"
          - "android14_5.15_153_2024-07_"
          - "android14_5.15_158_2024-08_"
          - "android14_5.15_167_2024-11_"
          - "android14_5.15_170_2025-01_"
          - "android14_6.1_75_2024-05_"
          - "android14_6.1_118_2025-01_"
          - "android15_6.6_50_2024-10_"
          - "android15_6.6_56_2024-11_"
          - "android15_6.6_57_2024-12_"
          - "android15_6.6_58_2025-01_"
          - "android15_6.6_66_2025-02_"
          - "android15_6.6_77_2025-03_"
          - "android15_6.6_X_lts_"
        default: "android14_6.1_75_2024-05_"
      kernelsu_branch:
        description: "é€‰æ‹©SukiSUåŠŸèƒ½åˆ†æ”¯"
        required: true
        type: choice
        options:
          - Stable
          - Dev
        default: Dev
      custom_version_suffix:
        description: 'è‡ªå®šä¹‰å†…æ ¸å†…éƒ¨ç‰ˆæœ¬åç¼€(uname -r), ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼'
        required: false
        type: string
      use_zram:
        description: 'å¯ç”¨é¢å¤–ZRAMç®—æ³•'
        required: true
        type: boolean
        default: true
      use_kpm:
        description: 'å¯ç”¨KPMåŠŸèƒ½'
        required: true
        type: boolean
        default: false
      upload_to_release:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ° GitHub Release'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'

jobs:
  precheck_sukisu_version:
    name: é¢„è®¡ç®—SukiSUç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    outputs:
      job_name_suffix: ${{ steps.calculate_version.outputs.job_suffix }}
      sukisu_version_string: ${{ steps.calculate_version.outputs.suki_version_actual }}
      technical_branch: ${{ steps.calculate_version.outputs.technical_branch }}
    steps:
      - name: å®‰è£…Git
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq --no-install-recommends git
      - name: è®¡ç®—SukiSUç‰ˆæœ¬å·
        id: calculate_version
        shell: bash
        run: |
          set -euo pipefail
          suki_version_actual="è·å–å¤±è´¥"
          job_suffix_text=""
          SUKI_REPO_URL="https://github.com/ShirkNeko/SukiSU-Ultra.git"
          
          TECHNICAL_BRANCH="susfs-main" # Stable
          if [[ "${{ github.event.inputs.kernelsu_branch }}" == "Dev" ]]; then
            TECHNICAL_BRANCH="susfs-1.5.8" # Dev
          fi
          echo "technical_branch=${TECHNICAL_BRANCH}" >> $GITHUB_OUTPUT
          
          echo "Performing a FULL clone of '$SUKI_REPO_URL' to get all branch and tag info..."

          if ! git clone "$SUKI_REPO_URL" SukiSU_temp_for_version; then
            echo "::error::Full clone failed. Repo URL might be incorrect or inaccessible."
            exit 1
          fi

          cd SukiSU_temp_for_version

          # æ­¥éª¤ 1: ä»ä¸»åˆ†æ”¯è·å–æœ€æ–°çš„ release tag
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "Default branch is: $DEFAULT_BRANCH"
          release_tag=$(git describe --tags --abbrev=0 "origin/$DEFAULT_BRANCH" 2>/dev/null || echo "notag")
          echo "Latest release tag from '$DEFAULT_BRANCH' is: $release_tag"

          # æ­¥éª¤ 2: åˆ‡æ¢åˆ°ç›®æ ‡å¼€å‘åˆ†æ”¯, è·å–å…¶ commit hash
          echo "Checking out '$TECHNICAL_BRANCH' to get its specific commit hash..."
          if ! git checkout "$TECHNICAL_BRANCH"; then
            echo "::error::Failed to checkout '$TECHNICAL_BRANCH'. It may not exist in the repo."
            exit 1
          fi
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "nohash")
          echo "Commit hash from '$TECHNICAL_BRANCH' is: $SHORT_COMMIT_HASH"
          
          # æ­¥éª¤ 3: æ‹¼æ¥æˆæœ€ç»ˆç‰ˆæœ¬å·
          if [[ "$release_tag" != "notag" && "$SHORT_COMMIT_HASH" != "nohash" ]]; then
            suki_version_actual="${release_tag}-${SHORT_COMMIT_HASH}@${TECHNICAL_BRANCH}"
            job_suffix_text=" (é¢„æœŸSukiSU ${suki_version_actual})"
          else
            suki_version_actual="è®¡ç®—é”™è¯¯ - tag: ${release_tag}, hash: ${SHORT_COMMIT_HASH}"
            job_suffix_text=" (SukiSU - ç‰ˆæœ¬é¢„è®¡ç®—å¤±è´¥)"
          fi
          
          echo "job_suffix=${job_suffix_text}" >> $GITHUB_OUTPUT
          echo "suki_version_actual=${suki_version_actual}" >> $GITHUB_OUTPUT
          
          cd .. && rm -rf SukiSU_temp_for_version

  build_kernel:
    name: å†…æ ¸ç¼–è¯‘ - ${{ github.event.inputs.kernel_to_build }}${{ needs.precheck_sukisu_version.outputs.job_name_suffix }}
    needs: precheck_sukisu_version
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.generate_release_info.outputs.artifact_name_for_release }}
      release_tag: ${{ steps.generate_release_info.outputs.release_tag_name }}
      release_title: ${{ steps.generate_release_info.outputs.release_title_name }}
      stable_release_tag_for_action: ${{ steps.generate_release_info.outputs.stable_release_tag_for_action }}
      final_kernel_local_version_output: ${{ steps.generate_suffixes.outputs.final_kernel_local_version_for_release_body }}
      current_build_date_formatted_output: ${{ steps.generate_suffixes.outputs.current_build_date_formatted_for_release_body }}
      parsed_kernel_version_output: ${{ steps.parse_kernel.outputs.parsed_kernel_version }}
      parsed_sub_level_output: ${{ steps.parse_kernel.outputs.parsed_sub_level }}
      sukisu_version_from_source: ${{ needs.precheck_sukisu_version.outputs.sukisu_version_string }}
      gki_defconfig_path_output: ${{ steps.set_core_paths.outputs.gki_defconfig_path_output }}
      effective_kpm_setting: ${{ steps.kpm_settings.outputs.effective_kpm_value }}
    env:
      CCACHE_COMPILERCHECK: '%compiler% -dumpmachine; %compiler% -dumpversion'
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      BAZEL_OPTIMIZATION_FLAGS: "--jobs=$(nproc) --local_ram_resources=HOST_RAM*0.8"
      CCACHE_LOGFILE: /tmp/ccache.log
      BAZEL_PROFILE_FILENAME: bazel_profile.json
      DEBIAN_FRONTEND: noninteractive
      SUKI_VERSION_NUM: ${{ needs.precheck_sukisu_version.outputs.sukisu_version_string }}
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          set -euo pipefail
          kernel_input="${{ github.event.inputs.kernel_to_build }}"
          if [[ -z "$kernel_input" ]]; then
            echo "::error::'kernel_to_build' input is empty."
            exit 1
          fi
      - name: è§£æå†…æ ¸å‚æ•°
        id: parse_kernel
        run: |
          set -euo pipefail
          IFS='_' read -r av kv sl opl rev_raw <<< "${{ github.event.inputs.kernel_to_build }}"
          echo "SELECTED_ANDROID_VERSION=$av" >> $GITHUB_ENV
          echo "SELECTED_KERNEL_VERSION=$kv" >> $GITHUB_ENV
          echo "SELECTED_SUB_LEVEL=$sl" >> $GITHUB_ENV
          echo "SELECTED_OS_PATCH_LEVEL=$opl" >> $GITHUB_ENV
          rev="${rev_raw:-}"
          echo "SELECTED_REVISION=$rev" >> $GITHUB_ENV
          echo "parsed_kernel_version=$kv" >> $GITHUB_OUTPUT
          echo "parsed_sub_level=$sl" >> $GITHUB_OUTPUT
      - name: è®¾ç½®æ ¸å¿ƒè·¯å¾„
        id: set_core_paths
        run: |
          set -euo pipefail
          CONFIG_DIR_NAME_VALUE="${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}-${{ env.SELECTED_SUB_LEVEL }}"
          echo "CONFIG=${CONFIG_DIR_NAME_VALUE}" >> $GITHUB_ENV
          KERNEL_SOURCE_DIRECTORY_VALUE="${GITHUB_WORKSPACE}/${CONFIG_DIR_NAME_VALUE}"
          echo "KERNEL_SRC_ROOT=${KERNEL_SOURCE_DIRECTORY_VALUE}" >> $GITHUB_ENV
          GKI_DEFCONFIG_FILE_PATH_VALUE="${KERNEL_SOURCE_DIRECTORY_VALUE}/common/arch/arm64/configs/gki_defconfig"
          echo "GKI_DEFCONFIG_PATH_ENV=${GKI_DEFCONFIG_FILE_PATH_VALUE}" >> $GITHUB_ENV
          echo "gki_defconfig_path_output=${GKI_DEFCONFIG_FILE_PATH_VALUE}" >> $GITHUB_OUTPUT
      - name: è°ƒæ•´KPMè®¾ç½®
        id: kpm_settings
        run: |
          set -euo pipefail
          EFFECTIVE_KPM_VALUE=""
          if [[ "${{ env.SELECTED_ANDROID_VERSION }}" == "android15" && "${{ env.SELECTED_KERNEL_VERSION }}" == "6.6" ]]; then
            EFFECTIVE_KPM_VALUE="false"
          else
            EFFECTIVE_KPM_VALUE="${{ github.event.inputs.use_kpm }}"
          fi
          echo "EFFECTIVE_USE_KPM=${EFFECTIVE_KPM_VALUE}" >> $GITHUB_ENV
          echo "effective_kpm_value=${EFFECTIVE_KPM_VALUE}" >> $GITHUB_OUTPUT
      - name: ä¼˜åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yq --no-install-recommends ccache python3 git curl time libssl-dev flex
      - name: é…ç½®ccache
        run: |
          set -euo pipefail
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          if ccache --version | grep -q 'Zstd'; then
            ccache --set-config=compression_type=zstd
          fi
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -s
      - name: è¿˜åŸccacheç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-v2-${{ github.event.inputs.kernel_to_build }}-${{ hashFiles('.github/workflows/**.yml') }}
          restore-keys: |
            ${{ runner.os }}-ccache-v2-${{ github.event.inputs.kernel_to_build }}-
            ${{ runner.os }}-ccache-v2-
      - name: ç¼“å­˜é¢„ç¼–è¯‘å·¥å…·é“¾
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: |
            kernel-build-tools
            mkbootimg
          key: toolchain-${{ runner.os }}-v3
      - name: ä¸‹è½½é¢„ç¼–è¯‘å·¥å…·é“¾
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          AOSP_MIRROR=https://android.googlesource.com
          BUILD_TOOLS_BRANCH=main-kernel-build-2024
          MKBOOTIMG_BRANCH=main
          git clone "$AOSP_MIRROR/kernel/prebuilts/build-tools" -b "$BUILD_TOOLS_BRANCH" --depth 1 kernel-build-tools
          git clone "$AOSP_MIRROR/platform/system/tools/mkbootimg" -b "$MKBOOTIMG_BRANCH" --depth 1 mkbootimg
      - name: è®¾ç½®å·¥å…·é“¾ç¯å¢ƒå˜é‡
        run: |
          set -euo pipefail
          echo "AVBTOOL=$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/bin/avbtool" >> $GITHUB_ENV
          echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py" >> $GITHUB_ENV
          echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py" >> $GITHUB_ENV
      - name: è®¾ç½®ç­¾åå¯†é’¥
        env:
          BOOT_SIGN_KEY: ${{ secrets.BOOT_SIGN_KEY }}
        run: |
          set -euo pipefail
          KEY_DIR="$GITHUB_WORKSPACE/kernel-build-tools/linux-x86/share/avb"
          mkdir -p "$KEY_DIR"
          if [ -z "$BOOT_SIGN_KEY" ]; then
            openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 > "$KEY_DIR/testkey_rsa2048.pem"
            echo "BOOT_SIGN_KEY_PATH=$KEY_DIR/testkey_rsa2048.pem" >> $GITHUB_ENV
          else
            echo "$BOOT_SIGN_KEY" > "$KEY_DIR/production_key.pem"
            echo "BOOT_SIGN_KEY_PATH=$KEY_DIR/production_key.pem" >> $GITHUB_ENV
          fi
      - name: å®‰è£…repoå·¥å…·
        run: |
          set -euo pipefail
          mkdir -p ./git-repo
          curl -sS https://storage.googleapis.com/git-repo-downloads/repo > ./git-repo/repo
          chmod a+rx ./git-repo/repo
          echo "REPO=$GITHUB_WORKSPACE/./git-repo/repo" >> $GITHUB_ENV
      - name: å…‹éš†ä¾èµ–ä»“åº“
        run: |
          set -euo pipefail
          ANYKERNEL_BRANCH="gki-2.0"
          SUSFS_BRANCH="gki-${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}"
          git clone https://github.com/WildPlusKernel/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AnyKernel3
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b "$SUSFS_BRANCH" susfs4ksu
          git clone https://github.com/WildPlusKernel/kernel_patches.git kernel_patches
          git clone https://github.com/ShirkNeko/SukiSU_patch.git SukiSU_patch
      - name: åŒæ­¥å†…æ ¸æºç 
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: |
            set -euo pipefail
            mkdir -p "${{ env.KERNEL_SRC_ROOT }}"
            cd "${{ env.KERNEL_SRC_ROOT }}"
            _MANIFEST_BRANCH_BASE="common-${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}"
            _MANIFEST_BRANCH=""
            if [[ -n "${{ env.SELECTED_OS_PATCH_LEVEL }}" && "${{ env.SELECTED_OS_PATCH_LEVEL }}" != "X" ]]; then
              _MANIFEST_BRANCH="${_MANIFEST_BRANCH_BASE}-${{ env.SELECTED_OS_PATCH_LEVEL }}"
            elif [[ "${{ github.event.inputs.kernel_to_build }}" == *"_X_lts_"* || "${{ github.event.inputs.kernel_to_build }}" == *"_lts_"* ]]; then
              _MANIFEST_BRANCH="${_MANIFEST_BRANCH_BASE}-lts"
            else
              _MANIFEST_BRANCH="${_MANIFEST_BRANCH_BASE}"
            fi
            ${{ env.REPO }} init --depth=1 -u https://android.googlesource.com/kernel/manifest -b $_MANIFEST_BRANCH --repo-rev=v2.16
            DEFAULT_MANIFEST_PATH=".repo/manifests/default.xml"
            if [ ! -f "$DEFAULT_MANIFEST_PATH" ] && [ -f .repo/manifest.xml ]; then
              DEFAULT_MANIFEST_PATH=.repo/manifest.xml
            fi
            COMMON_PROJECT_REVISION_IN_MANIFEST=$(grep 'project path="common"' "$DEFAULT_MANIFEST_PATH" | sed -n 's/.*revision="\([^"]*\)".*/\1/p' | head -n 1)
            if [ -z "$COMMON_PROJECT_REVISION_IN_MANIFEST" ]; then
                COMMON_PROJECT_REVISION_IN_MANIFEST=$(grep 'project path="kernel/common"' "$DEFAULT_MANIFEST_PATH" | sed -n 's/.*revision="\([^"]*\)".*/\1/p' | head -n 1)
                if [ -z "$COMMON_PROJECT_REVISION_IN_MANIFEST" ]; then
                  COMMON_PROJECT_REVISION_IN_MANIFEST=$_MANIFEST_BRANCH
                fi
            fi
            REMOTE_COMMON_BRANCH_STATUS=$(git ls-remote https://android.googlesource.com/kernel/common "$COMMON_PROJECT_REVISION_IN_MANIFEST")
            if echo "$REMOTE_COMMON_BRANCH_STATUS" | grep -q "refs/heads/deprecated/$COMMON_PROJECT_REVISION_IN_MANIFEST"; then
              sed -i "/project path=\"common\"/s|revision=\"$COMMON_PROJECT_REVISION_IN_MANIFEST\"|revision=\"deprecated/$COMMON_PROJECT_REVISION_IN_MANIFEST\"|" "$DEFAULT_MANIFEST_PATH" || \
              sed -i "/project path=\"kernel\/common\"/s|revision=\"$COMMON_PROJECT_REVISION_IN_MANIFEST\"|revision=\"deprecated/$COMMON_PROJECT_REVISION_IN_MANIFEST\"|" "$DEFAULT_MANIFEST_PATH"
            fi
            ${{ env.REPO }} --trace sync -c -j$(nproc --all) --no-tags --fail-fast --current-branch
      - name: é›†æˆSukiSU (KernelSU)
        working-directory: ${{ env.KERNEL_SRC_ROOT }}
        run: |
          set -euo pipefail
          echo "Adding SukiSU..."
          SUKI_BRANCH_ARG="-s ${{ needs.precheck_sukisu_version.outputs.technical_branch }}"
          echo "Using SukiSU setup argument: $SUKI_BRANCH_ARG"
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash $SUKI_BRANCH_ARG
      - name: åº”ç”¨SUSFSè¡¥ä¸
        working-directory: ${{ env.KERNEL_SRC_ROOT }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Applying SUSFS patches..."
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}.patch ./common/
          cp -r ../susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp -r ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cd ./common
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}.patch || { echo "::error::SUSFS common patch failed."; exit 1; }
          cd - >/dev/null
      - name: åº”ç”¨å†…æ ¸è¡¥ä¸
        shell: bash
        run: |
          set -euo pipefail
          COMMON_DIR_PATH="${{ env.KERNEL_SRC_ROOT }}/common"
          apply_hooks_patch() {
            cd "$COMMON_DIR_PATH"||exit 1
            HOOKS_PATCH_FILE="${GITHUB_WORKSPACE}/SukiSU_patch/hooks/syscall_hooks.patch"
            if [ -f "$HOOKS_PATCH_FILE" ]; then
              cp "$HOOKS_PATCH_FILE" ./syscall_hooks.patch
              patch -p1 -F 3 < syscall_hooks.patch || { echo "::error::SukiSU hooks patch failed."; exit 1; }
            fi
          }
          apply_zram_compression_patches() {
            if [[ "${{ github.event.inputs.use_zram }}" == "true" ]]; then
              cd "$COMMON_DIR_PATH"||exit 1
              ZRAM_PATCH_BASE="${GITHUB_WORKSPACE}/SukiSU_patch/other/zram"
              local src_inc="${ZRAM_PATCH_BASE}/lz4k/include/linux"; local dst_inc="./include/linux"
              if [ -d "$src_inc" ]; then mkdir -p "$dst_inc"; if [ -n "$(ls -A "$src_inc" 2>/dev/null)" ]; then cp -r "${src_inc}/." "$dst_inc/" || exit 1; fi; fi
              local src_lib="${ZRAM_PATCH_BASE}/lz4k/lib"; local dst_lib="./lib"
              if [ -d "$src_lib" ]; then mkdir -p "$dst_lib"; if [ -n "$(ls -A "$src_lib" 2>/dev/null)" ]; then cp -r "${src_lib}/." "$dst_lib/" || exit 1; fi; fi
              local src_crypto="${ZRAM_PATCH_BASE}/lz4k/crypto"; local dst_crypto="./crypto"
              if [ -d "$src_crypto" ]; then mkdir -p "$dst_crypto"; if [ -n "$(ls -A "$src_crypto" 2>/dev/null)" ]; then cp -r "${src_crypto}/." "$dst_crypto/" || exit 1; fi
              else exit 1; fi
              if [ -d "${ZRAM_PATCH_BASE}/lz4k_oplus" ]; then mkdir -p ./lib; cp -r "${ZRAM_PATCH_BASE}/lz4k_oplus" ./lib/ || exit 1; fi
              LZ4KD_PATCH="${ZRAM_PATCH_BASE}/zram_patch/${{env.SELECTED_KERNEL_VERSION}}/lz4kd.patch"
              if [ -f "$LZ4KD_PATCH" ]; then cp "$LZ4KD_PATCH" ./lz4kd.patch; patch -p1 -F 3 < lz4kd.patch || exit 1; fi
              LZ4KOPLUS_PATCH="${ZRAM_PATCH_BASE}/zram_patch/${{env.SELECTED_KERNEL_VERSION}}/lz4k_oplus.patch"
              if [ -f "$LZ4KOPLUS_PATCH" ]; then cp "$LZ4KOPLUS_PATCH" ./lz4k_oplus.patch; patch -p1 -F 3 < lz4k_oplus.patch || exit 1; fi
            fi
          }
          apply_hide_stuff_patch() {
            cd "$COMMON_DIR_PATH"||exit 1
            HIDE_PATCH_FILE="${GITHUB_WORKSPACE}/SukiSU_patch/69_hide_stuff.patch"
            if [ -f "$HIDE_PATCH_FILE" ]; then
              cp "$HIDE_PATCH_FILE" ./hide_stuff.patch
              patch -p1 -F 3 < hide_stuff.patch || { echo "::error::Hide stuff patch failed."; exit 1; }
            fi
          }
          apply_hooks_patch & PID_HOOKS=$!
          apply_zram_compression_patches & PID_ZRAM=$!
          apply_hide_stuff_patch & PID_HIDE=$!
          FAIL=0
          wait $PID_HOOKS || FAIL=1
          wait $PID_ZRAM || FAIL=1
          wait $PID_HIDE || FAIL=1
          if [ "$FAIL" -eq 1 ]; then
            exit 1
          fi
      - name: é…ç½®ZRAMç®—æ³•
        if: ${{ github.event.inputs.use_zram == 'true' }}
        run: |
          set -euo pipefail
          CONFIG_FILE_PATH="${{ env.GKI_DEFCONFIG_PATH_ENV }}"
          if [ ! -f "$CONFIG_FILE_PATH" ]; then exit 1; fi
          update_cfg() {
            local k="$1"; local v="$2"
            if grep -q "^${k}=" "$CONFIG_FILE_PATH"; then sed -i "s|^${k}=.*|${k}=${v}|" "$CONFIG_FILE_PATH"; else echo "${k}=${v}" >> "$CONFIG_FILE_PATH"; fi
            sed -i "/^# ${k} is not set/d" "$CONFIG_FILE_PATH"
          }
          update_cfg "CONFIG_ZSMALLOC" "y"; update_cfg "CONFIG_ZRAM" "y"
          if [ "${{ env.SELECTED_KERNEL_VERSION }}" = "5.10" ]; then update_cfg "CONFIG_MODULE_SIG" "n"; update_cfg "CONFIG_CRYPTO_LZO" "y"; update_cfg "CONFIG_ZRAM_DEF_COMP_LZ4KD" "y"; fi
          if [ "${{ env.SELECTED_ANDROID_VERSION }}" = "android14" ] || [ "${{ env.SELECTED_ANDROID_VERSION }}" = "android15" ]; then
            MP="${{ env.KERNEL_SRC_ROOT }}/common/modules.bzl"; if [ -f "$MP" ]; then sed -i 's/"drivers\/block\/zram\/zram\.ko",//g; s/"mm\/zsmalloc\.ko",//g' "$MP"; fi
            update_cfg "CONFIG_MODULE_SIG_FORCE" "n"
          elif [ "${{ env.SELECTED_KERNEL_VERSION }}" = "5.10" ] || [ "${{ env.SELECTED_KERNEL_VERSION }}" = "5.15" ]; then
            GMF="${{ env.KERNEL_SRC_ROOT }}/common/android/gki_aarch64_modules"; if [ -f "$GMF" ]; then echo -n > "$GMF"; fi
          fi
          if grep -q "^CONFIG_ZSMALLOC=y$" "$CONFIG_FILE_PATH" && grep -q "^CONFIG_ZRAM=y$" "$CONFIG_FILE_PATH"; then
            update_cfg "CONFIG_CRYPTO_LZ4HC" "y"; update_cfg "CONFIG_CRYPTO_LZ4K" "y"
            update_cfg "CONFIG_CRYPTO_LZ4KD" "y"; update_cfg "CONFIG_CRYPTO_842" "y"; update_cfg "CONFIG_CRYPTO_LZ4K_OPLUS" "y"
          fi
          sort -u "$CONFIG_FILE_PATH" -o "$CONFIG_FILE_PATH"
      - name: é…ç½®SUSFSåŠŸèƒ½
        run: |
          set -euo pipefail
          GKI_PATH="${{ env.GKI_DEFCONFIG_PATH_ENV }}"; if [ ! -f "$GKI_PATH" ]; then exit 1; fi
          upd_cfg() { local k="$1"; local v="$2"; sed -i -e "/^${k}=/d" -e "/^# ${k} is not set/d" "$GKI_PATH"; echo "${k}=${v}" >> "$GKI_PATH"; }
          cfgs_y=( "CONFIG_KSU" "CONFIG_KSU_MANUAL_HOOK" "CONFIG_TMPFS_XATTR" "CONFIG_TMPFS_POSIX_ACL" "CONFIG_IP_NF_TARGET_TTL" "CONFIG_IP6_NF_TARGET_HL" "CONFIG_IP6_NF_MATCH_HL" "CONFIG_TCP_CONG_ADVANCED" "CONFIG_TCP_CONG_BBR" "CONFIG_NET_SCH_FQ" "CONFIG_KSU_SUSFS" "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT" "CONFIG_KSU_SUSFS_SUS_PATH" "CONFIG_KSU_SUSFS_SUS_MOUNT" "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT" "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT" "CONFIG_KSU_SUSFS_SUS_KSTAT" "CONFIG_KSU_SUSFS_TRY_UMOUNT" "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT" "CONFIG_KSU_SUSFS_SPOOF_UNAME" "CONFIG_KSU_SUSFS_ENABLE_LOG" "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS" "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG" "CONFIG_KSU_SUSFS_OPEN_REDIRECT" )
          cfgs_n=( "CONFIG_KSU_SUSFS_SUS_SU" "CONFIG_KSU_SUSFS_SUS_OVERLAYFS" "CONFIG_TCP_CONG_BIC" "CONFIG_TCP_CONG_WESTWOOD" "CONFIG_TCP_CONG_HTCP" )
          for ck in "${cfgs_y[@]}"; do upd_cfg "$ck" "y"; done
          for cn in "${cfgs_n[@]}"; do upd_cfg "$cn" "n"; done
          if [[ "${{ env.EFFECTIVE_USE_KPM }}" == "true" ]]; then upd_cfg "CONFIG_KPM" "y"; else upd_cfg "CONFIG_KPM" "n"; fi
          sort -u "$GKI_PATH" -o "$GKI_PATH"
          for fp in "${{ env.KERNEL_SRC_ROOT }}/common/build.config.gki" "${{ env.KERNEL_SRC_ROOT }}/common/build.config.gki.aarch64" "${{ env.KERNEL_SRC_ROOT }}/common/build.config"; do
            if [ -f "$fp" ]; then sed -i 's/check_defconfig//g' "$fp"; fi
          done

      # ========================= START: MODIFIED SECTION =========================
      - name: ç”Ÿæˆç‰ˆæœ¬åç¼€å’Œæ—¥æœŸ
        id: generate_suffixes
        env:
          USER_PROVIDED_SUFFIX: ${{ github.event.inputs.custom_version_suffix }}
          SELECTED_AV_ENV: ${{ env.SELECTED_ANDROID_VERSION }}
          SELECTED_KV_ENV: ${{ env.SELECTED_KERNEL_VERSION }}
        run: |
          set -euo pipefail
          final_kernel_local_version=""
          current_date_yyyymmdd=$(date +%Y%m%d)
          echo "current_build_date_formatted_for_release_body=$(date +"%Yå¹´%mæœˆ%dæ—¥")" >> $GITHUB_OUTPUT
          echo "BUILD_DATE_YYYYMMDD=${current_date_yyyymmdd}" >> $GITHUB_ENV

          if [[ -n "$USER_PROVIDED_SUFFIX" ]]; then
            final_kernel_local_version="$USER_PROVIDED_SUFFIX"
            echo "Using user-provided suffix: $final_kernel_local_version"
          else
            kernel_fixed_part_for_localversion=""
            if [ "$SELECTED_AV_ENV" == "android12" ] && [ "$SELECTED_KV_ENV" == "5.10" ]; then kernel_fixed_part_for_localversion="-android12-9"
            elif [ "$SELECTED_AV_ENV" == "android13" ] && [ "$SELECTED_KV_ENV" == "5.10" ]; then kernel_fixed_part_for_localversion="-android13-9"
            elif [ "$SELECTED_AV_ENV" == "android13" ] && [ "$SELECTED_KV_ENV" == "5.15" ]; then kernel_fixed_part_for_localversion="-android13-8"
            elif [ "$SELECTED_AV_ENV" == "android14" ] && [ "$SELECTED_KV_ENV" == "6.1" ]; then kernel_fixed_part_for_localversion="-android14-11"
            elif [ "$SELECTED_AV_ENV" == "android15" ] && [ "$SELECTED_KV_ENV" == "6.6" ]; then kernel_fixed_part_for_localversion="-android15-8"
            else kernel_fixed_part_for_localversion="-${SELECTED_AV_ENV}-${SELECTED_KV_ENV//./_}-custom"; fi
            
            random_hex_11=$(head /dev/urandom | LC_ALL=C tr -dc 'a-f0-9' | head -c 11 || echo "randhex")
            random_digits_8=$(head /dev/urandom | LC_ALL=C tr -dc '0-9' | head -c 8 || echo "randdig")
            final_kernel_local_version="${kernel_fixed_part_for_localversion}-gd${random_hex_11}-ab${random_digits_8}"
            echo "Generated pseudo-official suffix: $final_kernel_local_version"
          fi
          echo "FINAL_KERNEL_LOCAL_VERSION=${final_kernel_local_version}" >> "$GITHUB_ENV"
          echo "final_kernel_local_version_for_release_body=${final_kernel_local_version}" >> $GITHUB_OUTPUT

      - name: é…ç½®å†…æ ¸ç‰ˆæœ¬å‚æ•°
        working-directory: ${{ env.KERNEL_SRC_ROOT }}
        run: |
          set -euo pipefail
          GKI_DEFCONFIG="${{ env.GKI_DEFCONFIG_PATH_ENV }}"
          SLS="./common/scripts/setlocalversion"
          
          # æ¸…ç†defconfigä¸­çš„ç‰ˆæœ¬è®¾ç½®ï¼Œé˜²æ­¢å†…æ ¸è‡ªèº«é€»è¾‘å’Œæˆ‘ä»¬çš„å¼ºåˆ¶è®¾å®šå†²çª
          if [ -f "$GKI_DEFCONFIG" ]; then
            sed -i '/^CONFIG_LOCALVERSION=/d' "$GKI_DEFCONFIG"
            echo 'CONFIG_LOCALVERSION=""' >> "$GKI_DEFCONFIG"
            sed -i '/^CONFIG_LOCALVERSION_AUTO=/d' "$GKI_DEFCONFIG"
            echo '# CONFIG_LOCALVERSION_AUTO is not set' >> "$GKI_DEFCONFIG"
            sort -u "$GKI_DEFCONFIG" -o "$GKI_DEFCONFIG"
          fi

          # å¼ºåˆ¶è¦†ç›–setlocalversionè„šæœ¬ï¼Œè®©å®ƒåªè¾“å‡ºæˆ‘ä»¬ç”Ÿæˆçš„ç‰ˆæœ¬å·
          if [ -f "$SLS" ]; then
            if [[ -n "${{ env.FINAL_KERNEL_LOCAL_VERSION }}" ]]; then
              echo '#!/bin/sh' > "$SLS"
              echo 'echo "${{ env.FINAL_KERNEL_LOCAL_VERSION }}"' >> "$SLS"
              chmod +x "$SLS"
            else
              # å¦‚æœæ²¡æœ‰ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼‰ï¼Œåˆ™åªæ¸…ç†-dirtyæ ‡è®°ä»¥é˜²ä¸‡ä¸€
              sed -i 's/-dirty//g' "$SLS"
            fi
          fi

          # æ¸…ç†Bazelæ„å»ºäº§ç”Ÿçš„-dirtyæ ‡è®°
          if [ ! -f "./build/build.sh" ]; then
            if [ -f "./common/BUILD.bazel" ]; then sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' "./common/BUILD.bazel"; fi
            find ./common/android/ -name "abi_gki_protected_exports_*" -delete
            if [ -f "./build/kernel/kleaf/impl/stamp.bzl" ]; then sed -i "/stable_scmversion_cmd/s/-maybe-dirty//g" "./build/kernel/kleaf/impl/stamp.bzl"; fi
          fi
      # ========================== END: MODIFIED SECTION ==========================

      - name: æ ¡éªŒå…³é”®å†…æ ¸é…ç½®
        run: |
          set -euo pipefail
          GKI_CHECK="${{ env.GKI_DEFCONFIG_PATH_ENV }}"; if [ ! -f "$GKI_CHECK" ]; then exit 1; fi
          CRIT_FAIL=0
          check_cfg() {
            local k="$1"; local ev="$2"; local c="${3:-false}"
            if ! grep -q "^${k}=${ev}$" "$GKI_CHECK"; then
              if [[ "$c" == "true" ]]; then echo "::error::CRITICAL: ${k}!= ${ev}"; CRIT_FAIL=1
              else echo "::warning::${k}!=${ev}"; fi
            else echo "${k}=${ev} OK."; fi
          }
          check_cfg "CONFIG_KSU" "y" "true"; check_cfg "CONFIG_KSU_SUSFS" "y" "false"; check_cfg "CONFIG_MODVERSIONS" "y" "false"
          if [[ "${{ github.event.inputs.use_zram }}" == "true" ]]; then
            check_cfg "CONFIG_ZRAM" "y" "true"; check_cfg "CONFIG_CRYPTO_LZ4K" "y" "true"
          fi
          if [ "$CRIT_FAIL" -ne 0 ]; then cat "$GKI_CHECK"; exit 1; fi
      - name: æ‰§è¡Œå†…æ ¸ç¼–è¯‘
        uses: nick-fields/retry@v3
        env:
          BAZEL_PROFILE_PATH_IN_WORKSPACE: "${{ github.workspace }}/${{ env.BAZEL_PROFILE_FILENAME }}"
        with:
          timeout_minutes: 75
          max_attempts: 2
          retry_on: timeout
          command: |
            set -euo pipefail
            set -x
            BAZEL_WAS_USED="false"
            execute_build_process() {
              cd "${{ env.KERNEL_SRC_ROOT }}" || exit 1
              B_SCRIPT="./build/build.sh"
              BZL_CACHE="/home/runner/.cache/bazel_disk_cache"
              mkdir -p "$BZL_CACHE"
              if [ -f "$B_SCRIPT" ]; then
                LTO=thin SYSTEM_DLKM_RE_SIGN=0 BUILD_SYSTEM_DLKM=0 KMI_SYMBOL_LIST_STRICT_MODE=0 BUILD_CONFIG=common/build.config.gki.aarch64 CC="/usr/bin/ccache clang" /usr/bin/time -v ./build/build.sh
              else
                BAZEL_WAS_USED="true"
                /usr/bin/time -v bash -c "tools/bazel build --disk_cache=\"${BZL_CACHE}\" --config=fast --lto=thin --profile=\"${BAZEL_PROFILE_PATH_IN_WORKSPACE}\" $BAZEL_OPTIMIZATION_FLAGS //common:kernel_aarch64_dist"
              fi
            }
            execute_build_process
            ccache --show-stats
            if [ -n "${CCACHE_LOGFILE}" ] && [ -f "${CCACHE_LOGFILE}" ]; then
              tail -n 10 "${CCACHE_LOGFILE}" || true
            fi
            if [ "$BAZEL_WAS_USED" = "true" ]; then
              if [ ! -f "${BAZEL_PROFILE_PATH_IN_WORKSPACE}" ]; then
                echo "::warning::Bazel profile file was expected (Bazel build path taken) but not found at ${BAZEL_PROFILE_PATH_IN_WORKSPACE}."
              fi
            fi
      - name: KPMä¿®è¡¥ (Android 12/13)
        if: env.EFFECTIVE_USE_KPM == 'true' && (env.SELECTED_ANDROID_VERSION == 'android12' || env.SELECTED_ANDROID_VERSION == 'android13') && env.SELECTED_KERNEL_VERSION != '6.6'
        run: |
          set -euo pipefail
          IMG_DIR="${{ env.KERNEL_SRC_ROOT }}/out/${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}/dist"
          IMG_FILE="$IMG_DIR/Image"
          if [ -d "$IMG_DIR" ] && [ -f "$IMG_FILE" ]; then
            cd "$IMG_DIR" || exit 1
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o pk
            chmod +x pk; ./pk
            if [ -f "oImage" ]; then mv Image Image.o; mv oImage Image; fi
          fi
      - name: KPMä¿®è¡¥ (Android 14/15)
        if: env.EFFECTIVE_USE_KPM == 'true' && (env.SELECTED_ANDROID_VERSION == 'android14' || env.SELECTED_ANDROID_VERSION == 'android15') && env.SELECTED_KERNEL_VERSION != '6.6'
        run: |
          set -euo pipefail
          IMG_DIR="${{ env.KERNEL_SRC_ROOT }}/bazel-bin/common/kernel_aarch64/"
          IMG_FILE="$IMG_DIR/Image"
          if [ -d "$IMG_DIR" ] && [ -f "$IMG_FILE" ]; then
            cd "$IMG_DIR" || exit 1
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o pk
            chmod +x pk; ./pk
            if [ -f "oImage" ]; then mv Image Image.o; mv oImage Image; fi
          fi
      - name: å¤åˆ¶å†…æ ¸æ˜ åƒåˆ°AnyKernel3
        run: |
          set -euo pipefail
          IMG_SRC=""
          LGC_IMG="${{ env.KERNEL_SRC_ROOT }}/out/${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}/dist/Image"
          BZL_IMG1="${{ env.KERNEL_SRC_ROOT }}/bazel-bin/common/kernel_aarch64/Image"
          BZL_IMG2="${{ env.KERNEL_SRC_ROOT }}/out/android-gki/dist/Image"
          if [ -f "$LGC_IMG" ]; then IMG_SRC="$LGC_IMG"
          elif [ -f "$BZL_IMG1" ]; then IMG_SRC="$BZL_IMG1"
          elif [ -f "$BZL_IMG2" ]; then IMG_SRC="$BZL_IMG2"
          else
            ls -R "${{ env.KERNEL_SRC_ROOT }}/out/" || true
            ls -R "${{ env.KERNEL_SRC_ROOT }}/bazel-bin/" || true
            exit 1
          fi
          AK3_DIR="$GITHUB_WORKSPACE/AnyKernel3"
          if [ ! -d "$AK3_DIR" ]; then exit 1; fi
          cp "$IMG_SRC" "$AK3_DIR/Image"
      - name: éªŒè¯å†…æ ¸é•œåƒç±»å‹
        run: |
          set -euo pipefail
          IMG_VALIDATE="$GITHUB_WORKSPACE/AnyKernel3/Image"
          if [ ! -f "$IMG_VALIDATE" ]; then exit 1; fi
          file_out=$(file "$IMG_VALIDATE")
          if ! (echo "$file_out" | grep -q "ARM64" && echo "$file_out" | grep -q "Linux kernel"); then
            exit 1
          fi
      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯å’Œæ–‡ä»¶å
        id: generate_release_info
        shell: bash
        run: |
          set -euo pipefail
          _svn="${{ env.SUKI_VERSION_NUM }}"
          _kv="${{ env.SELECTED_KERNEL_VERSION }}"
          _sl="${{ env.SELECTED_SUB_LEVEL }}"
          _date="${{ env.BUILD_DATE_YYYYMMDD }}"
          _base="SukiSUUltra"
          _aname=""
          _tit=""
          _tag=""
          _stable_group_tag=""
          if [[ "$_svn" != "NoVer" && "$_svn" != "" && "$_svn" != "è·å–å¤±è´¥" && ! "$_svn" == *notag* && ! "$_svn" == *è®¡ç®—é”™è¯¯* && ! "$_svn" == *å…‹éš†é”™è¯¯* && ! "$_svn" == *æºç ç›®å½•ä¸å­˜åœ¨* ]]; then
            _sanitized_svn=$(echo "$_svn" | sed 's/[^a-zA-Z0-9._@-]/_/g')
            _stable_group_tag="${_base}-${_sanitized_svn}"
            _tit="${_base} ${_svn}"
            _aname="AnyKernel3_${_base}_${_sanitized_svn}_${_kv}-${_sl}-${_date}"
            _tag="${_base}-${_sanitized_svn}_${_kv}-${_sl}-${_date}"
          else
            _stable_group_tag="${_base}-NoVer"
            _tit="${_base}-NoVer-${_date}"
            _aname="AnyKernel3_${_base}_NoVer_${_kv}-${_sl}-${_date}"
            _tag="${_base}-NoVer_${_kv}-${_sl}-${_date}"
          fi
          echo "artifact_name_for_release=${_aname}" >> "$GITHUB_OUTPUT"
          echo "release_tag_name=${_tag}" >> "$GITHUB_OUTPUT"
          echo "release_title_name=${_tit}" >> "$GITHUB_OUTPUT"
          echo "stable_release_tag_for_action=${_stable_group_tag}" >> "$GITHUB_OUTPUT"
      - name: ä¸Šä¼ å†…æ ¸åˆ·æœºåŒ… Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.generate_release_info.outputs.artifact_name_for_release }}
          path: ${{ github.workspace }}/AnyKernel3
          if-no-files-found: error
      - name: æ¸…ç†æ„å»ºç©ºé—´
        if: always()
        run: |
          set -euo pipefail
          if [ -d "/home/runner/.cache/bazel_disk_cache" ]; then rm -rf /home/runner/.cache/bazel_disk_cache || echo "::warning::Bazel disk cache removal failed."; fi
          if [ -d "$HOME/.cache/bazel" ]; then rm -rf "$HOME/.cache/bazel" || echo "::warning::Bazel repo cache removal failed."; fi
          ccache -s
      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.SELECTED_ANDROID_VERSION }}-${{ env.SELECTED_KERNEL_VERSION }}-${{ github.run_id }}
          path: |
            ${{ env.CCACHE_LOGFILE }}
            ${{ github.workspace }}/${{ env.BAZEL_PROFILE_FILENAME }}
          if-no-files-found: ignore

  create_release:
    name: åˆ›å»º GitHub Release
    needs: build_kernel
    permissions:
      contents: write
    runs-on: ubuntu-latest
    if: success() && github.event.inputs.upload_to_release == 'true'
    steps:
      - name: å®‰è£… zip å·¥å…·
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq --no-install-recommends zip
      - name: ä¸‹è½½å†…æ ¸åˆ·æœºåŒ… Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build_kernel.outputs.artifact_name }}
          path: downloaded_artifact/
      - name: æ‰“åŒ…å†…æ ¸åˆ·æœºåŒ…
        id: package_kernel
        shell: bash
        run: |
          set -euo pipefail
          cd downloaded_artifact
          final_zip="${{ needs.build_kernel.outputs.artifact_name }}.zip"
          if [ -z "$(ls -A .)" ]; then exit 1; fi
          zip -r9 "../${final_zip}" .
          cd ..
          if [ ! -f "${final_zip}" ]; then exit 1; fi
          echo "packaged_zip=${final_zip}" >> $GITHUB_OUTPUT
      - name: åˆ›å»ºæˆ–æ›´æ–° Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: ${{ steps.package_kernel.outputs.packaged_zip }}
          tag: ${{ needs.build_kernel.outputs.stable_release_tag_for_action }}
          name: ${{ needs.build_kernel.outputs.stable_release_tag_for_action }}
          body: |
            ä¸€æšæ–°é²œè‡ªåŠ¨æ„å»ºçš„å†…æ ¸å·²é€è¾¾ï¼ ğŸš€

            --------------------------------------------------
            **ğŸ”¥ ä¸»è¦ä¿¡æ¯ ğŸ”¥**
            * **SukiSU ç‰ˆæœ¬:** `${{ needs.build_kernel.outputs.sukisu_version_from_source }}`
            * **åŸºäºå†…æ ¸:** `${{ github.event.inputs.kernel_to_build }}`
            * **åŠŸèƒ½åˆ†æ”¯:** `${{ github.event.inputs.kernelsu_branch }}`
            --------------------------------------------------

            **âš™ï¸ è¯¦ç»†å‚æ•° âš™ï¸**
            * **å†…æ ¸å†…éƒ¨ç‰ˆæœ¬ (uname -r):**
                `${{ needs.build_kernel.outputs.parsed_kernel_version_output }}.${{ needs.build_kernel.outputs.parsed_sub_level_output }}${{ needs.build_kernel.outputs.final_kernel_local_version_output }}`
            * **æ„å»ºæ—¥æœŸ:**
                `${{ needs.build_kernel.outputs.current_build_date_formatted_output }}`
            * **å†…éƒ¨ç‰ˆæœ¬åç¼€è®¾ç½®:**
                `${{ github.event.inputs.custom_version_suffix == '' && 'ä»¿å®˜æ–¹éšæœºç”Ÿæˆ' || format('è‡ªå®šä¹‰: {0}', github.event.inputs.custom_version_suffix) }}`

            **ğŸ› ï¸ ç¼–è¯‘ç‰¹æ€§ ğŸ› ï¸**
            * âœ… **ZRAM:** `${{ github.event.inputs.use_zram }}`
            * âœ… **KPM:** `${{ needs.build_kernel.outputs.effective_kpm_setting }}`

            **ğŸ”— è¿½è¸ªä¿¡æ¯ ğŸ”—**
            * **SHA:** `${{ github.sha }}`
            * **æ„å»º ID:** `${{ github.run_id }}`
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: false